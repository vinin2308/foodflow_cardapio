name: Deploy Full Stack (Hash Version)

on:
  push:
    branches: [ "main" ]

jobs:
  # ---------------------------------------------------
  # JOB 1: BUILD DO BACKEND
  # ---------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    steps:
    - name: Baixar c√≥digo
      uses: actions/checkout@v3

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build e Push Backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend/foodflow
        push: true
        tags: |
          vininobre/foodflow-backend:latest
          vininobre/foodflow-backend:${{ github.sha }}

  # ---------------------------------------------------
  # JOB 2: BUILD DO FRONTEND
  # ---------------------------------------------------
  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - name: Baixar c√≥digo
      uses: actions/checkout@v3

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build e Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          vininobre/foodflow-frontend:latest
          vininobre/foodflow-frontend:${{ github.sha }}

  # ---------------------------------------------------
  # JOB 3: DEPLOY NA AWS
  # ---------------------------------------------------
  deploy-to-aws:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
    - name: Conectar na AWS e Atualizar
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_DNS }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "üöÄ --- INICIANDO DEPLOY COM HASH ${{ github.sha }} ---"

          # ----------------------------------
          # 1. ATUALIZAR BACKEND
          # ----------------------------------
          echo "üîÑ Atualizando imagem do Backend..."
          # Sintaxe: deployment/NOME_DEPLOYMENT NOME_CONTAINER=IMAGEM
          kubectl set image deployment/backend backend=vininobre/foodflow-backend:${{ github.sha }}
          
          echo "‚è≥ Aguardando Backend ficar 'Running'..."
          kubectl rollout status deployment/backend

          # ----------------------------------
          # 2. RODAR MIGRATE (Seguro)
          # ----------------------------------
          echo "üò¥ Esperando 20 segundos para limpar pods antigos..."
          sleep 20
          
          echo "üîç Buscando pod do backend ATIVO..."
          POD_BACKEND=$(kubectl get pods | grep "^backend-" | grep "Running" | awk '{print $1}' | head -n 1)
          
          POD_BACKEND=$(echo $POD_BACKEND | xargs)

          if [ -z "$POD_BACKEND" ]; then
             echo "‚ùå ERRO CR√çTICO: N√£o achei nenhum pod 'Running'. Abortando migrate."
             kubectl get pods
             exit 1
          else
             echo "üì¶ Pod VIVO encontrado: $POD_BACKEND"
             echo "üõ†Ô∏è Rodando Migrate..."
             kubectl exec $POD_BACKEND -- python manage.py migrate --noinput
             
             echo "üé® Rodando Collectstatic..."
             kubectl exec $POD_BACKEND -- python manage.py collectstatic --noinput
          fi

          # ----------------------------------
          # 3. ATUALIZAR FRONTEND
          # ----------------------------------
          echo "üîÑ Atualizando imagem do Frontend..."
          # CORRE√á√ÉO AQUI: O container se chama 'frontend', n√£o 'foodflow'
          kubectl set image deployment/frontend frontend=vininobre/foodflow-frontend:${{ github.sha }}
          
          kubectl rollout status deployment/frontend

          echo "‚úÖ DEPLOY FINALIZADO COM SUCESSO! üçî Hash: ${{ github.sha }}"