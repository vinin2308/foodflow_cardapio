name: Deploy Full Stack (Back + Front + Migrate)

on:
  push:
    branches: [ "main" ] # Ou "master"

jobs:
  # ---------------------------------------------------
  # JOB 1: BUILD DO BACKEND (DJANGO)
  # ---------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    steps:
    - name: Baixar c√≥digo
      uses: actions/checkout@v3

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build e Push Backend
      uses: docker/build-push-action@v4
      with:
        # ATEN√á√ÉO: Se seu backend est√° numa subpasta, mude o context para './backend'
        context: ./backend/foodflow
        # Se seu Dockerfile tem outro nome ou local, especifique aqui:
        # file: ./backend/Dockerfile
        push: true
        tags: vininobre/foodflow-backend:latest

  # ---------------------------------------------------
  # JOB 2: BUILD DO FRONTEND (ANGULAR)
  # ---------------------------------------------------
  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - name: Baixar c√≥digo
      uses: actions/checkout@v3

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build e Push Frontend
      uses: docker/build-push-action@v4
      with:
        # ATEN√á√ÉO: Se seu frontend est√° numa subpasta, mude o context para './frontend'
        context: . 
        # file: ./frontend/Dockerfile
        push: true
        tags: vininobre/foodflow-frontend:latest

  # ---------------------------------------------------
  # JOB 3: DEPLOY NA AWS (Roda depois dos builds)
  # ---------------------------------------------------
  deploy-to-aws:
    needs: [build-backend, build-frontend] # S√≥ roda se os dois acima derem certo
    runs-on: ubuntu-latest
    steps:
    - name: Conectar na AWS e Atualizar Tudo
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_DNS }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "üöÄ --- INICIANDO DEPLOY COMPLETO ---"

          # ===========================
          # ATUALIZANDO BACKEND
          # ===========================
          echo "üîÑ Reiniciando Backend..."
          kubectl rollout restart deployment/backend
          
          # TRAVA O SCRIPT at√© o backend subir (Necess√°rio para rodar o migrate)
          echo "‚è≥ Aguardando Backend ficar 'Running'..."
          kubectl rollout status deployment/backend

          # ===========================
          # RODANDO MIGRATE (Obrigat√≥rio)
          # ===========================
          # Pega o nome do pod novo automaticamente
          POD_BACKEND=$(kubectl get pods -l app=backend -o jsonpath="{.items[0].metadata.name}")
          
          if [ -z "$POD_BACKEND" ]; then
             echo "‚ùå ERRO CR√çTICO: N√£o achei o pod do backend. Abortando migrate."
             exit 1
          else
             echo "üì¶ Rodando Migrate no pod: $POD_BACKEND"
             kubectl exec $POD_BACKEND -- python manage.py migrate --noinput
             
             echo "üé® Rodando Collectstatic (Garantia para o Admin)..."
             kubectl exec $POD_BACKEND -- python manage.py collectstatic --noinput
          fi

          # ===========================
          # ATUALIZANDO FRONTEND
          # ===========================
          echo "üîÑ Reiniciando Frontend..."
          kubectl rollout restart deployment/frontend
          
          # Aguarda frontend subir
          kubectl rollout status deployment/frontend

          echo "‚úÖ DEPLOY FINALIZADO COM SUCESSO! üçî"